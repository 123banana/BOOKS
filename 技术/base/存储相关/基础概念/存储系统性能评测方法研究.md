# 存储系统性能评测方法研究
## 测试难点
- 第一，由于实际环境资源的限制，测试不具有可扩展性，难以评测大规模云存储系统的性能；
- 第二，难以模拟足够多的用户同时访问云存储系统；
- 第三，测试环境构建复杂，需要花费大量的人力物力，测试时间长；
- 第四，准备测试环境，测试成本投入高；
- 第五，测试过程受网络因素及外界其他因素影响，评测结果不稳定。

## 解决问题
提出一种公有云存储系统性能评测方法——“云测试云”，该方法通过在云计算平台动态申请足够数量的实例，对云存储系统性能进行评测。
## 方案优点
- 第一，在云计算平台上动态按需申请实例，可以模拟足够数量的用户，具有很好的扩展性；
- 第二，评测过程自动化部署，节约人力物力，使评测过程更高效；
- 第三，使用云计算资源构建评测环境，节约测试成本；
- 第四，评测过程相对屏蔽网络因素的影响，使评测过程稳定；
- 第五，该方法可以适用于任何公有云存储平台，具有很好的通用性。

## 目标
- 第一，提出一种公有云存储系统性能评测方法——“云测试云”；
- 第二，构建通用的性能评测框架，可动态伸缩申请实例，自动化部署评测工具及负载，控制并发访问云存储系统，自动释放实例及收集并反馈评测结果；
- 第三，提出多维度的性能评测指标，涵盖不同典型应用、不同云存储接口；
- 第四，提出一种可扩展通用的性能评测模型，可以适用于任何的公有云存储平台，通过该模型可以评测常见典型应用的性能，并且可以分析用户使用机器类型、用户访问文件大小、同时访问用户数对云存储系统性能的影响。

## 云存储接口访问类型
- 块
- 数据库存储
- 对象

## 现有工具方法
对于对象存储测试需要从数据持久性、数据可用性、数据访问性能角度评测 Amazon S3(Simple Storage Service) 存储服务的性能。

- 方法一
	- 优点
	
		
		从5个不同的地区和 Amazon 内部的 EC2 角度采用横向对比评测 Amazon S3 性能; 
	- 缺电
	
		但是在评测 Amazon S3 并发访问性能时，采用不同地区的EC2单台虚拟机设置多线程来测试，这种方法不能模拟真实的多用户并发访问。
- 方法二

	调用 Amazon S3 提供的REST API 采用 Java、C++、Python 语言实现评测工具，但是该工具不能实现自动化部署。
- 方法三

	采用 C++ 语言调用 Amazon S3 API 实现评测工具，从 EC2 角度评测 Amazon S3 的吞吐量、并发访问及可用性。
	
	- 优点

		能分析时间因素和地区因素对 Amazon S3 性能的影响; 
	- 缺点

		没有分析不同实例类型及不同实例数量对 Amazon S3 性能的影响，并且评测方法使用单客户端进行评测，使得该评测方法不具有可扩展性。
- 方法四

	利用网络分析工具 iptools 获得云存储系统在处理用户访问请求的各个阶段的时间开销，从而建立模型评测云存储的性能，并且以百度云盘和金山快盘为测试对象进行实验，验证模型。
	
	- 缺点

		该方法只分析单客户访问云存储的性能，因此评测方法不具有扩展性。
- 方法五

	采用网络嗅探工具 Ethereal ，通过捕获网盘客户端传输文件的数据包的方式来确定其传输时间、计算传输速率。
	
	- 优点

		采用所提方法横向对比三种典型网盘的性能，但不足是只分析单用户访问的性能，没有分析多用户同时访问的性能，评测方法不具有可扩展性。
- 方法六

	研发评测 Openstack Swift 应用服务接口层性能工具 CSPTS (Cloud Storage Performance Test System)，通过调用Swift 开放的 API 接口，测试文件读写和元数据操作的性能。
- 方法七

	对公有云存储 Azure 和私有云存储 Nimbus 进行性能评价，使用集成 benchmark 和负载应用程序对性能进行评价，主要指标有计算性能、网络性能和成本。

	- 优点在于将所提性能评测方法在公有云存储 Azure 和私有云存储 Nimbus 上进行对比评测，评测指标多样化，但没有具体说明提出的性能评测方法。

## 测试框架
构建通用的性能评测框架，主要包括4个模块：

![](./pic/storage.jpg)

1. 控制决策模块。首先，对用户提交的需求说明进行需求分析；然后，根据需求分析结果创建虚拟机组；接着，给创建的所有虚拟机发送工具和负载信息，并且控制虚拟机进行访问操作；其次，当访问测试模块完成时，从各个虚拟机中收集评测结果；最后，当用户收到评测结果后，释放虚拟组。
2. 资源调度模块。主要根据控制决策模块发送的请求消息启动虚拟机组。
3. 访问测试模块。所有新启动的虚拟机根据控制决策模块的需求分析信息访问云存储系统，进行元数据访问或者数据访问。
4. 结果处理模块。主要负责处理控制决策模块从各个虚拟机收集的评测结果，分为单节点结果处理和多节点结果处理，并将分析结果反馈给用户。

## 评测指标
### 通用性能测试指标
- IOPS

	测试本地存储系统每秒处理的IO请求数，单位为IO次数/秒 (IOPS)。
- 数据传输率

	测试本地存储系统在单位时间内的最大数据传输率，单位为兆字节/秒 (MB/s)。
- 元数据吞吐率

	本地存储系统在单位时间内能够处理的元数据量，单位为次/秒。
- 并发数

	同一时间内能够支持的最大用户访问数目。

### 面向不同典型应用和不同云存储接口的多维度性能评测指标
- 面向不同典型应用的评测指标

	典型应用性能：针对不同用户机器类型、不同网络环境、不同测试时间点，测试典型应用的完成时间，单位为秒 。

	典型应用的性能不只与用户上传下载的文件大小有关系，并且和文件的读写访问模式有关系。如云相册，用户一次写入，多次进行读访问，并且用户一般访问不是下载单个照片，而是下载某个相册整体。常见的云存储系统典型应用。	
	
	因为文件、软件、视频等用户使用时都会有大文件和小文件、大软件和小软件之分，所以设置两个参数值，并且只对小文件，小软件、小视频等作测试。
	
	应用|单文件平均大小|读写模式|访问模式
	---|---|---|---
	文档备份|4MB|少写多度|单个访问
	文件共享|小1MB-大1GB|多写多读|整体访问
	软件备份|小100MB-大10GB|少写多读|整体访问
	视频监控|小500MB-大5GB|多写少读|单个访问
	云相册|小1GB-大5GB|多写多读|整体访问
	
- 面向不同云存储接口的评测指标

	云存储系统的不同接口访问类型，可以分为块存储接口、对象存储接口、数据库存储接口，不同接口的具体评测指标
	
	接口|评测指标|标准|单位
	---|---|---|---
	块存储|聚合带宽|单位时间上传数据、下载数据的速率|MB/秒
	x|响应时间|测试上传、下载数据的API响应时间|秒
	对象存储|聚合带宽|单位时间内文件成功上传、下载的速|MB/秒
	x|元数据操作吞吐率|单位时间内进行元数据操作的次数|秒-1
	x|响应时间|测试成功上传、下载文件的API响应时间|秒
	x|并发数|同一时间内支持的最大用户访问数|
### 测试模型
在评测指标的基础上提出两种通用可扩展的公有云存储系统性能评测模型：典型应用性能评测模型和云存储接口层性能评测模型。
	
- 典型应用性能评测模型

	可以分析用户使用不同典型应用在不同访问模式、不同机器类型、不同网络环境和不同测试时间点时完成时间；
		
	![](./pic/model1.jpg)
		
- 云存储接口层性能评测模型

	可以评测用户使用的机器类型、用户访问的文件大小及同时访问的用户数对云存储系统性能的影响
		
	![](./pic/model2.jpg)

- 典型应用性能评测模型的具体执行流程

	首先将不同的典型应用在不同时间，部署到不同区域的不同类型机器上；然后评测出不同典型应用在不同访问模式、不同时间、不同区域、不同类型机器上的完成时间。

- 云存储系统云存储接口层性能评测模型主要分为两个阶段，具体执行流程
	- 第一阶段因素分析
		1. 评测云存储系统性能和实例类型之间的关系。固定文件大小 (一般设置小文件) 和用户数量 (一般设置单用户)，评测实例类型 (即用户使用的机器类型) 对云存储系统性能的影响。
		2. 确定最优文件大小。不同云存储系统支持的最优文件大小不同，固定实例类型 (一般设置小配置实例类型) 和用户数量 (单用户)，寻找评测的云存储系统支持访问的最优文件大小，即用户上传、下载时的最优文件大小, 并且分析文件大小和云存储系统性能之间的关系。
		3. 确定云存储系统支持的最大用户数。云存储系统支持的最大用户数，与用户使用的实例类型及用户上传或下载的文件大小有关系，所以在评测时，将实例类型设置为较优实例配置，将文件大小设置为小文件，进而评测云存储系统同时支持的最大用户访问数，并且分析用户数和云存储系统性能之间的关系。
	- 第二段

		当用户使用云存储系统时，通过统筹规划动态调整上述分析的各个因素，尽可能地为用户提供较优的性能，从而为用户的使用提供指导建议。

## AWS S3 测试用例使用情况
为了验证本文提出“云测试云”的公有云存储系统性能评测方法的可行性、合理性、通用性和可扩展性，本文在Amazon S3平台上进行实验验证。
### 测试指标
- 面向不同典型应用的评测指标。

	应用|单文件平均大小|读写模式|访问模式
	---|---|---|---
	文档备份|4MB|少写多度|单个访问
	文件共享|小1MB-大1GB|多写多读|整体访问
	软件备份|小100MB-大10GB|少写多读|整体访问
	视频监控|小500MB-大5GB|多写少读|单个访问
	云相册|小1GB-大5GB|多写多读|整体访问
- 面向不同云存储接口的评测指标

	操作类型|评测指标|标准|单位
	---|---|---|---
	元数据操作|Create Bucket\Delete Bucket\List Buckets\Delete Object\List Objects|单位时间内进行元数据操作的次数|秒-1
	数据操作|聚合带宽|单位时间内文件成功上传、下载的速|MB/秒
	x|响应时间|测试成功上传、下载文件的API响应时间|秒
	x|并发数|同一时间内支持的最大用户访问数|

### 测试环境
所有的实验都选择在 Amazon EC2 平台东京地区进行(同机房),、
![](./pic/top.jpg)

实验时选择不同的虚拟机实例类型进行实验对比,处理器为Intel Xeon E5-2670 v2 2.50 GHz，内核版本为3.13.0-48-generic，操作系统为Ubuntu 14.04.2 LTS，实例存储为EBS only，测试 vm 配置

实例类型| cpu | 内存(GB)|网络性能
---|---|---|---
t2.nano|1v CPU|0.5|Low to Moderate
t2.micro|1v CPU|1.0|Low to Moderate
t2.small|1v CPU|2.0|Low to Moderate
t2.medium|2v CPU|4.0|Low to Moderate
t2.large|2v CPU|8.0|Low to Moderate
m4.large|2v CPU|8.0|Moderate

### 试验方法
通用可扩展的评测模型，评测过程分为两部分进行：

- 第一部分评测不同典型应用的完成时间。

	只评测不同典型应用在同一时间、相同区域 (Amazon EC2平台东京地区)、相同机器类型 (t2.micro) 上的完成时间。

- 第二部分评测 Amazon S3 云存储系统性能影响因素。

	只评测数据操作时的 MBPS 和 API 响应时间。

	1. 判断 Amazon S3 云存储性能和用户使用机器类型的关系，文件大小固定为 100 MB，实例数量固定为1台，实例类型分别设置为：t2.nano、t2.micro、t2.small、t2.medium、t2.large、m4.large。
	2. 判断 Amazon S3 云存储性能和用户访问文件大小的关系，实例类型固定为 t2.micro，实例数量固定为1台，文件大小分别设置为：1 MB、10 MB、50 MB、100 MB、500 MB、1 GB、1.5 GB、2 GB、3 GB。
	3. 判断 Amazon S3 云存储性能和同时访问用户数的关系，文件大小固定为100 MB，实例类型固定为t2.micro，实例数量分别设置为1台、2台、4台、8台、16台。

### 结果和分析
为了排除异常值的影响，每次测试进行5次实验，实验结果去掉一个最大值和一个最小值，然后将剩余的3次实验结果取平均。

- 第一部分 

	评测不同典型应用的完成时间。当用户同一时间使用 EC2 东京地区的 t2.micro 机器访问 Amazon S3 时，用户上传不同典型应用的完成时间。
	
	![](./pic/completion1.jpg)
- 第二部分

	评测 Amazon S3 云存储系统性能影响因素。
	
	1. 评测 Amazon S3 云存储性能和实例类型关系。
		- 系统文件传输速率
		
			![](./pic/completion2-1.jpg)
		- API响应时间
		
			![](./pic/completion2-2.jpg)
	
		可知:无论上传、下载文件，当实例类型为t2.nano、t2.micro、t2.small、t2.medium时，访问Amazon S3云存储系统的文件传输速率和API响应时间差异并不大; 但是当实例类型为t2.large和m4.large时，访问Amazon S3云存储系统的文件传输速率和API响应时间都比之前4种实例类型性较优。主要原因是t2.large和m4.large的CPU为2个，内存为8 GB，比其他实例类型配置提升一倍。

		因此，可得结论，当实例类型为t2.large和m4.large时，访问Amazon S3云存储系统性能较好。
	2. 评测Amazon S3云存储性能和文件大小关系	
		- 系统文件传输速率对

			![](./pic/completion3-1.jpg)
		- API响应时间

			![](./pic/completion3-2.jpg)
			
		可知，当文件大小从 1MB 到 1GB 逐渐增加时，上传下载文件的文件传输速率和 API 响应时间也随着增加。因为 Amazon S3 采用流量计费，所以由于经费限制，未测得 Amazon S3 支持的最优上传下载文件大小。
	3. 评测Amazon S3 云存储性能和实例个数关系	
		- 系统文件传输速率
			
			![](./pic/completion4-1.jpg)
			![](./pic/completion4-2.jpg)
		- API响应时间

			![](./pic/completion4-3.jpg)
		
		可知，当实例个数从 1 增加到 16 时，无论上传、下载文件, 文件传输速率和 API 响应时间都随着实例个数的增加而增加，成线性关系。同样，由于经费限制，未测得Amazon S3支持的最大用户访问数。

		但是，结合平均每个实例文件传输速率分析可得：
		
		- 平均上传速率随着实例数增加先降低后逐渐增加，并且增长幅度缓慢，因此可得继续增加实例个数，平均每个实例上传速率会趋于稳定甚至降低，故上传 100MB 文件的总速率也会趋于稳定。
		- 平均下载速率随着实例数增加而逐渐降低，因此可得继续增加实例个数，平均每个实例下载速率逐渐降低，故下载 100MB 文件的总速率会趋于稳定。

		综上所述，当实例个数增加到一定值时，并发访问 Amazon S3 云存储系统的上传、下载速率最终会趋于稳定	

## 工具验证
为了验证第3章研发的 Amazon S3 性能评测工具的准确性，本文使用开源工具 s3cmd 进行验证。
### 环境 top
使用s3cmd验证研发工具时，两种方式的实例配置相同，具体如下：东京地区，实例数1台，实例类型为t2.micro，操作系统为Ubuntu 14.04.2 LTS
![](./pic/test-tools1.jpg)
### 验证方法
因为s3cmd在上传下载文件时，以 15 MB 进行分块上传或下载。而S3CTC调用S3 API，查看API实现源码，以 8MB 分块进行文件处理。因此，为了避免文件分块时间的影响，使 s3cmd 可以准确验证研发工具准确性，设置验证测试的文件大小为1 MB、2 MB、4 MB、6 MB、8 MB。

具体验证方法如下：

- 首先，使用S3CTC测试1 MB、2 MB、4 MB、6 MB和8 MB文件的上传和下载速率；
- 其次，使用s3cmd测试1 MB、2 MB、4 MB、6 MB和8 MB文件的上传和下载速率；
- 最后，对比分析两种工具测试结果。
		
### 结果
![](./pic/tools-completion1.jpg)

可得，S3CTC和s3cmd相对比，S3CTC测试的上传文件速率较低，但是整体误差不超过0.62 MB/s

![](./pic/tools-completion2.jpg)

可得，S3CTC和s3cmd相对比，除下载1 MB文件外，下载其他大小文件时，S3CTC测试的下载文件速率较低，但是整体误差不超过0.32 MB/s。

综上所述，上传文件时，S3CTC和s3cmd相比，误差不超过0.62 MB/s；下载文件时，S3CTC和s3cmd相比，误差不超过0.32 MB/s。因此，通过验证可得，S3CTC可以准确测试Amazon S3公有云存储系统性能。

## 结束语
针对云存储性能评测的难点问题，本文提出一种“云测试云”的公有云存储系统性能评测方法，该方法通过在云计算平台动态申请足够数量的实例，对公有云存储系统性能进行评测。该方法创新在于：第一，构建通用的性能评测框架，可动态伸缩申请实例，自动化部署评测工具及负载，控制并发访问云存储系统，自动释放实例及收集并反馈评测结果；第二，提出多维度的性能评测指标，涵盖不同典型应用，不同云存储接口；第三，提出一种可扩展通用的性能评测模型，该模型可以评测常见典型应用的性能，分析云存储性能影响因素，可适用于任何的公有云存储平台。为了验证该方法的可行性、合理性、通用性和可扩展性，本文利用提出的方法研发Amazon S3云存储系统性能评测工具S3CTC, 使用该工具对Amazon S3云存储系统进行性能评测，并使用s3cmd验证S3CTC工具的准确性。实验结果表明本文方法具有很好的可行性和合理性，评测结果可以为企业开发者和个人用户提供参考意见。

未来的研究工作将该方法扩展到不同的云存储接口，如阿里云的OSS (Open Storage Service)、Ceph等，以及扩展不同的应用，如用户聊天记录备份等。

## 整合参考
[公有云存储系统性能评测方法研究](http://www.xml-data.org/JSJYY/2017-5-1229.htm)

						
