# DAG和DHT
## 区块链的技术发展历史
基于区块链技术而产生的数字加密货币发展到如今，已有了三代的更新。

- 第一代，区块链+PoW。

	第一代的数字货币以比特币、莱特币、以太坊（大都会分叉之前）等为典型，都是基于区块链技术，交易的确认通过工作量来证明（PoW），也就是通过挖矿的方式来实现。
- 第二代，区块链+PoS以及区块链+DPOS。

	第二代的数字货币以升级后的以太坊（大都会分叉之后）为典型，同样基于区块链技术，但是工作证明采取权益证明的方式(PoS)，可以理解为股票中的分红机制。
- 第三代，区块链+DAG，还有区块链+DHT。

	第三代的数字货币有 IOTA 和 ByteBall (字节雪球)，没有采用传统区块链技术（或者说是新型的区块链技术），而是全新的 DAG 技术。

## 什么是 DAG
在数据结构的图论中，图分为有向图和无向图两大类，在有向图中进一步进行约束形成了 DAG（有向无环图）。所谓无环是指它是由集合的顶点和有向边构成，每条边连接一个顶点到另一个。

假如顶点 A 开始沿着有序的边，最终循环回再次到 A 是不可能的（不存在环路）。

区块链是一个单一链式结构，而 DAG 已经是图的概念了。区块链通过区块（可以包含许多笔交易）通过每个区块对前区块的 hash 值包含进而链接起来。在 DAG 中，去掉了区块，每一笔交易发出后在验证时包含之前的比较新的交易 hash，通过这种方法验证之前的交易，同时链接进图状结构，以待后面的交易链接并验证和确认。

如图，左边是传统区块链，右边是 DAG

![](./pic/dag-1.png)

- 性能问题(扩展性问题)

	很显然，相比较区块链而言，DAG 的可扩展性变得更好，处理能力会大幅度提升。区块链在处理交易的时候，必须全网达成共识才能出块。而DAG不必全网达成共识，只需要后面链接的交易来确认即可。因为不需要单独的矿工通过挖矿来验证和确认交易，所以 DAG 就没有矿霸垄断算力的风险，可以更好的去中心化，转账手续费用也更低（甚至没有手续费）。DAG 可以比传统区块链结构更高效、更去中心化。通过 DAG 解决了性能问题。

- 安全问题
	- 传统区块链
		
		比特币区块链通过 UTXO 的设计巧妙的解决的双花问题。并且区块链的单一链式结构，在验证方面保证了必须全网共识才能确认交易有效，这就进一步避免了双花问题的产生。通过 POW（工作量证明）共识机制保证了如果想修改之前的交易必须拥有 51% 以上的算力才能做到。以太坊等其他区块链系统也继承了比特币区块链的安全性优势。
		
		![](./pic/dag-2.png)
		
		![](./pic/dht-2.png)
		
	- DAG 
	
		DAG系统更加复杂，IOTA 是针对物联网领域的区块链项目，其应用的就是 DAG 技术。后面用 IOTA 项目的共识算法来分析和简单了解一下IOTA是如何解决双花问题的。
	
	IOTA 的 DAG 叫做 Tangle（纠缠）。如果向 Tangle 中加入一笔新的交易，该交易必须引用之前的最新的没有被确认的2笔交易。

	假如红色代表冲突交易（可能是双花），绿色代表新加入的交易。如图:


	![](./pic/dag-3.png)
	从上图可以看到，新加入的交易在验证过程中，会发现存在两笔有冲突的交易。这样，IOTA 系统就发现了这个存在问题的两笔交易。然后由交易的随机选择（和确认的累积权重）确定一个有效，另外一个无效。引用无效交易的后续交易会被重新加入 Tangle 参与验证。

	这里可以明确几点
	
	1. 随着新加入的交易越来越多，新的交易选择引用之前交易是一定会引用到两个冲突交易的;
	- 交易被确认次数越多（简单理解就是深度越深），这个交易越安全。通过一个确认比率就可以认定该笔交易是合法有效的。
	
	从某方面来说，DAG 技术确实突破了传统区块链，带来了很多优势。但是 DAG 相比较区块链的设计更为复杂，因此其共识算法的安全性还有待于长时间的实际验证，并且代码的安全性也需要团队有出色的代码编写和审计能力。

## DAG vs Blockchain
那么相比传统区块链，这种机制有什么好处？

- 数据结构

	通过 DAG，每一笔交易就可以看作是一个区块，没有容量限制的问题，每一个区块有多个指向，拓展性强，因此能够实现数字货币较高的交易吞吐量（通过平行验证）。并且参与者越多，整个系统也会变得越来越安全和快速，确认时间会缩短，交易也完成的越来越快。
- 共识机制

	区块链中添加下一个区块需要多方进行竞争，并获取区块奖励或交易手续费。正因如此，共识和交易生成是分离开的，并且由网络的一小部分人来完成，通常会设置较高门槛（就像比特币一样），这样会导致进一步的中心化（算力垄断）。在DAG系统中，交易者本身就是矿工，网络中的每位参与者都能进行交易并且积极参与共识。通过这种方式，验证就能同步进行，网络能够保持完全去中心化，不需要矿工传递信任，也不需要支付交易手续费。


## 什么是 DHT
目前应用 DHT 技术的主要应用包括：BitTorrent，Git，Storm Botnet，Freenet, Yacy，IPFS 和 Holochain。前五种应用都属于传统互联网技术应用，后面两种涉及到目前大热的区块链行业。该技术跳出了区块链的概念束缚，没有区块，准确的说，DAG 还有 DHT 是和区块链并列的一种技术。想打破区块链的 CAP 问题（可扩展性、安全、去中心化的平衡），就必须跳出区块链的本身，在其他技术里寻找答案，进而取代和革新区块链。

## DHT 和区块链
DHT 和区块链 DHT 的全称是 Distributed Hash Table，即分布式哈希表技术，是一种分布式的存储方法。这种分布式网络不需要中心节点服务器，每个客户端负责一个小范围的路由，并负责存储一小部分数据，从而实现整个 DHT 网络的寻址和存储。在区块链世界中，利用 DHT 可以实现众多节点的网络发现，实现各个节点在去中心化场景中的互联，DHT 是非常重要的 P2P 网络技术之一。

![](./pic/dht-1.png)

DHT 网络还在于 KEY 最接近的节点上复制备份冗余信息，避免了单一节点失效问题。可以把整个 DHT 网络想象成一个大城市，那么每个客户端，就好比城市里各个角落的地图碎片，上面绘制了附近区域的地形情况，把这些地图碎片汇总后，整个城市的全貌也就出来了。DHT 是 P2P 网络(结构化 P2P )核心路由算法，主要是利用一致性 hash，把节点和资源都表示成一个 hash 值，放入到这个大的 hash 环中，每个节点负责路由靠近它的资源。

DHT 中的一些定义

- node

	负责 P2P 路由信息，P2P 网络的组网就是它来负责
- nodeid

	节点的唯一标识，是一个 160 bit 的 hash 值
- peer

	负责管理资源，生成种子文件，发布资源信息
- infohash

	资源的唯一标识，也是一个 160 bit 的 hash 值，其和 nodeid 使用同一个算法
- 距离

	距离是两个 hash 值进行异或(XOR)操作后的值，值越小，距离越
- 近节点和资源的距离

	nodeid XOR infohash 
- 两个节点之间的距离

	nodeid1 xor nodeid2
- 种子文件

	对某个资源的描述文件，种子文件包括了
	
	- 资源的 infohash(160bit)
	- 资源所在机器（nodeId IP PORT）
	- 离资源所在机器最近的N个机器（nodeid IP PORT）列表

## P2P 与 DHT 标准场景
1. 新节点加入网络

	新安装的 P2P 客户端是一个孤立的节点，如何和其他节点联系？需要有一个种子文件，种子文件中有多个该 P2P 网络中的 node 信息，根据种子文件中的节点列表，连接到 P2P 网络，并获取路由信息,获取最靠近新节点的节点列表
- 发布资源

	生成资源的 Infohash，查找和 infohash 距离最近的 N 个 Node，向这 N 个 node 广播新资源信息，告诉这些节点，生成的资源。然后这些 node 生成了资源，不过其路由信息生成资源的 node 上(也不在离这个节点的最近的 M node 上)，而是在和资源 infohash 最近的 N 个 node 上
- 查找某个资源
	1. 找到最靠近资源的 N 个 node (使用 nodeid xor infohash 算法来计算距离远近)
	- 向这些 node 发送资源查询信息
		- 如果有这个资源的详细信息，就返回给客户端
		- 否则返回离资源更近的 node 列表给客户端
			- 如果没查到信息，且没有更近的 node 了，那就说明这个资源没有提供者
			- 如果找到 node 信息(nodeid,ip,port)后,向这个 node 请求资源

实现 DHT 的技术有很多种，常见的有：

- Chord
- Pastry
- Kademlia等。

我们熟知的 BT 及 BT 的衍生派（Mainline, Btspilits, Btcomet, uTorrent…），eMule 及 eMule 各类  Mods(verycd, easy emules, xtreme…) 等 P2P 文件分享软件都是基于该算法来实现 DHT 网络的，如 

- BT 采用 Python 的Kademlia 实现叫作 khashmir
- eMule 采用 C++ 的 Kademlia 实现干脆就叫作 Kad

当然它们之间有些差别，但基础都是 Kademlia。

![](./pic/dht-3.png)

简单地说，DHT 就是一种分布式的存储和寻址技术。通过 DHT 数据结构它把 KEY 和 VALUE 用某种方式对应起来。

- 使用 hash() 函数把一个 KEY 值映射到一个 index 上：

		hash(KEY) = index
	这样就可以把一个 KEY 值同某个 index 对应起来。
- 然后把与这个 KEY 值对应的 VALUE 存储到 index 所标记的存储空间中。
- 最后每次查找 KEY 所对应的 VALUE 值时，只需要做一次hash() 运算就可以找到了。

以上就是寻址过程。

![](./pic/dht-4.png)

## IPFS
IPS 也采用了 DHT 作为全网分布式账本存储和寻址技术。提到账本就不得不提到 Blockchain 区块链技术，区块链简单说就是分布式记账技术，全网统一一个版本的账本，各个全节点 node 的账本全网一致，也就是每个参与者都复制一份账本，并通过 gossip 技术实时更新。那么区块链面临的 scaling 扩容问题的症结就在于此，全网同步一份相同的账本，有多少个节点就有多少个账本的复本，复本的存储空间和更新所耗费的带宽是对资源的浪费。IPS 的革新之处在于将全网账本分布式的存储在各个参与的节点上，并通过 DHT 寻址技术保证账本的完整性 integrity 和可检索性retrievability。

IPS 这个账本的存储不是每人一份复本，而是只有一份正本，在存储网络中，每个节点只会保存一部分区块数据。用户节点只需要保存最长的 60 个区块和对应的 Hash 以及对应区块。

在 IPS 上每人（或者说每一个设备）都是一个节点，也就是每个节点都会存储固定大小的数据，并不会随着系统运行的时间的增长而增大，因为会发生增长的数据只会存在于 DHT 中，而 DHT 网络会随着加入网络的客户端的增加可以很轻易的进行水平扩展。

IPS 在结构上实现了区块无线扩展的可能性，与此同时，任何一笔交易不会超过 2 秒，因为 1 秒是IPS出块的间隔。既然区块数据是存储到 DHT 中，而不需要再广播到系统中的每一个节点，那么就不太需要考虑网络带宽造成的区块扩容上限瓶颈，那么在区块进行打包的时候就可以将此刻之前发生的所有交易都打包到一个区块里。然后将区块的 Hash 值广播出去，而 Hash 的长度永远是固定的，需要消耗的网络带宽也永远是固定的。这样每一笔交易的延迟基本就是区块打包的间隔时间。因此 IPS 会将出块的间隔时间控制在 1 秒钟，从而使交易的延迟最多不超过 2 秒。每个节点存储的账本都是唯一的，并且是必要的，相对于 Blockchain，极大的降低了复本占用的空间和带宽，同时还保留了区块链的优势（如：不可篡改）。同时， IPS 在世界各地建立了多个安全节点来存储完整数据，以便在有问题发生在 DHT 网络中时自动执行数据恢复，所有以前的事务都可以包装在最新的块中。

## 参考
[深度思考 || DAG和DHT的深度探讨](https://www.jianshu.com/p/31bde88753d8)